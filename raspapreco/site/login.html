<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/jquery-ui.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
</head>

<body>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header header">
        <button aria-controls="navbar" aria-expanded="false" class="navbar-toggle collapsed" data-target="#97bf8afda672ef73a836d55f018b43c868a97bb5"
          data-toggle="collapse" type="button">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand">Login</span>
      </div>
      <div class="navbar-collapse collapse" id="97bf8afda672ef73a836d55f018b43c868a97bb5">
        <ul class="nav navbar-nav">
          <li>
            <a href="/" title="Site">Brasilico's Site</a>
          </li>
          <li class="active">
            <a href="/raspapreco/" title="raspapreco">Raspa Preço</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="alert alert-danger alert-dismissible collapse" role="alert" id="jsonerror">
      <button type="button" class="close" onclick="$('#jsonerror').hide()" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      <span>
        <p>Erro na conexão ao Servidor!
          <span id="erro"></span>
        </p>
      </span>
    </div>
    <div class="alert alert-success alert-dismissible collapse" role="alert" id="jsonsuccess">
      <button type="button" class="close" onclick="$('#jsonsuccess').hide()" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      <span>
        <p>Sucesso:&nbsp;
          <span id="success"></span>
        </p>
      </span>
    </div>
    <ul id="rowTab" class="nav nav-tabs">
      <li class="active">
        <a data-toggle="tab" href="#login">Login</a>
      </li>
    </ul>
    <div class="tab-content">
      <div id="login" class="tab-pane fade in active">
        <div id="logindetalhe" class="row">
          <form id="frmlogin">
            <input type="hidden" id="id" name="id">
            <div class="form-group">
              <label for="nome">Nome:</label>
              <input type="text" class="form-control" id="nome" name="nome">
            </div>
            <div class="form-group">
              <label for="senha">Senha:</label>
              <input type="text" class="form-control" id="senha" name="senha">
            </div>
            <button class="btn btn-block btn-primary btn-default" id="btnlogin">
              <i class="fa fa-save"></i>&nbsp;Entrar
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div id="bottom" class="row">
    <div class="col-md-12">
      Copyleft IvanBrasilico 2017 - All stuff GPLv3 Licensed except explicited or from outer sources
    </div>
  </div>
  </div>
  </div>
  <script src="/static/js/jquery.min.js"></script>
  <script src="/static/js/bootstrap.min.js"></script>
  <script src="/static/js/jquery-ui.min.js"></script>
  <script type="text/javascript">
    $("#frmlogin").submit(function (event) {
      event.preventDefault();
    });
    $(document).ready(function () {
    });
    $(document).on('click', '#btnlogin', function () {
      login();
    });

    var login = function () {
      $('#jsonsuccess').hide();
      $('#jsonerror').hide();
      url = '/auth'
      data = {'username': $('#nome').val(), 'password': $('#senha').val()}
      console.log(data)
      $.ajax({
        headers: {
          'Content-Type': 'application/json',
        },
        url: url,
        type: 'post',
        dataType: 'json',
        data: JSON.stringify(data),
        success: function (data) {
          console.log(data.access_token);
          test_token(data.access_token);
          clear_form($('#frmlogin'));
          $('#success').empty().append("Login efetuado.")
          $('#jsonsuccess').show();
        },
        error: function (data) {
          console.log(data.responseJSON);
          if (data.responseJSON) {
            $('#erro').empty().append(data.responseJSON["description"])
          } else {
            $('#erro').empty().append('Servidor retornou erro. Usuário ou senha incorretos??')
          }
          $('#jsonerror').show();
        }
      });
    }
    var clear_form = function (form) {
      $.each(form[0].elements, function (index, formField) {
        if (formField.name) {
          $(formField).val('');
        }
      });
    };
    var test_token = function (token) {
      url = '/protected'
      $.ajax({
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'JWT ' + token
        },
        url: url,
        type: 'get',
        dataType: 'json',
        success: function (data) {
          console.log(data);
        },
        error: function (data) {
          console.log(data);
        }
      });
    };

  </script>
</body>

</html>